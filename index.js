
const treeJSON = '{"g":"2001","20":{"g":"2033","30":{"g":"2032","22":{"g":"2023"}},"10":{"g":"2213","20":{"g":"2111"},"30":{"g":"2211"},"21":{"g":"2221"},"00":{"g":"0000"},"10":{"g":"1011"},"12":{"g":"2121"}},"11":{"g":"2311","21":{"g":"3011"},"30":{"g":"2321"},"10":{"g":"2202"},"01":{"g":"3000"}},"20":{"g":"2131","10":{"g":"2022"},"21":{"g":"1031"},"01":{"g":"0003"},"30":{"g":"2231"}},"21":{"g":"2203","11":{"g":"2331"},"20":{"g":"3003"},"02":{"g":"3031"}},"01":{"g":"1101"},"02":{"g":"1301","22":{"g":"3101"}},"03":{"g":"3301"},"22":{"g":"2303"},"12":{"g":"2302"}},"12":{"g":"1202","20":{"g":"3200","30":{"g":"0200"},"13":{"g":"0302"},"22":{"g":"0203"},"21":{"g":"1300"},"20":{"g":"1100"}},"21":{"g":"1012","30":{"g":"1032"},"12":{"g":"3102"}},"30":{"g":"1102","21":{"g":"1203"},"20":{"g":"0202"},"30":{"g":"1302"}},"12":{"g":"0211","11":{"g":"0022"},"12":{"g":"3012"},"03":{"g":"1023"},"30":{"g":"0231"}},"11":{"g":"3100","30":{"g":"0100"},"03":{"g":"0032"},"22":{"g":"0103"},"12":{"g":"1010"},"13":{"g":"1030"}},"13":{"g":"2210","13":{"g":"0221"}},"22":{"g":"1022"},"03":{"g":"0121","13":{"g":"2110"},"30":{"g":"0321"},"03":{"g":"2310"},"12":{"g":"2130"}},"04":{"g":"2120"},"02":{"g":"3200","04":{"g":"0023"},"21":{"g":"3010"},"12":{"g":"0020"},"03":{"g":"0013"},"11":{"g":"0010"},"22":{"g":"3020"}}},"21":{"g":"3021","21":{"g":"0031","12":{"g":"3002"}},"12":{"g":"2012","20":{"g":"2030"},"03":{"g":"1201"},"11":{"g":"1003"},"02":{"g":"0301"}},"20":{"g":"0011","11":{"g":"2020"}},"22":{"g":"3201"},"02":{"g":"2200"},"11":{"g":"0101","20":{"g":"0002"},"12":{"g":"1000"}},"04":{"g":"2103"},"03":{"g":"2102","20":{"g":"2300"}},"13":{"g":"2013"},"30":{"g":"1021"}},"22":{"g":"2100","13":{"g":"1002","13":{"g":"0201"}},"22":{"g":"2010"},"04":{"g":"0021"}},"03":{"g":"0132","30":{"g":"0112","20":{"g":"0130"},"30":{"g":"0122"}},"13":{"g":"0213","13":{"g":"1230"},"04":{"g":"3120"}},"11":{"g":"0220"},"12":{"g":"1120","20":{"g":"0320"},"11":{"g":"0310"}},"21":{"g":"0212","20":{"g":"0230"}},"04":{"g":"1320","13":{"g":"3210"}},"03":{"g":"1210","30":{"g":"1220"}},"22":{"g":"0312","13":{"g":"0123"}},"20":{"g":"0110"}},"11":{"g":"1231","12":{"g":"2133","21":{"g":"2213"},"30":{"g":"2132"},"02":{"g":"0311"},"20":{"g":"1103"},"11":{"g":"1013"},"04":{"g":"3321"}},"04":{"g":"2113"},"02":{"g":"3013","12":{"g":"3302"},"22":{"g":"3103"},"02":{"g":"2320"},"20":{"g":"3022"},"01":{"g":"2122"},"30":{"g":"3023"}},"03":{"g":"2112","30":{"g":"2312"},"20":{"g":"2313"},"21":{"g":"2123"}},"30":{"g":"1221","20":{"g":"3231"},"30":{"g":"1211"}},"10":{"g":"0033","22":{"g":"3030"},"30":{"g":"0030"},"01":{"g":"2220"}},"01":{"g":"3300","22":{"g":"0303"},"30":{"g":"0300"}},"11":{"g":"3202","30":{"g":"3203"},"11":{"g":"1303"},"01":{"g":"0111"},"03":{"g":"2330"},"20":{"g":"2212"},"21":{"g":"3032"}},"20":{"g":"0331","11":{"g":"2230"},"13":{"g":"1033"}},"21":{"g":"0131","20":{"g":"1121"},"11":{"g":"3221"}},"22":{"g":"3211","13":{"g":"1321"}},"13":{"g":"3121"}},"10":{"g":"3311","30":{"g":"1311","20":{"g":"3331"},"22":{"g":"3111"}},"12":{"g":"1131"},"11":{"g":"2332","22":{"g":"2323"},"11":{"g":"3033"},"30":{"g":"2333"}},"20":{"g":"1111","00":{"g":"3303"}},"01":{"g":"2223","22":{"g":"2232"}},"10":{"g":"2322"},"22":{"g":"1331","22":{"g":"3131"}},"00":{"g":"2222"},"02":{"g":"2233"}},"02":{"g":"0133","12":{"g":"1332","12":{"g":"3230"},"22":{"g":"1323"},"04":{"g":"3213"},"02":{"g":"3110"}},"21":{"g":"3132","20":{"g":"1130"},"22":{"g":"3123"},"03":{"g":"0323"},"21":{"g":"0332"},"13":{"g":"1233"},"11":{"g":"0330"}},"02":{"g":"1312","21":{"g":"3212"},"02":{"g":"3220"},"30":{"g":"1322"}},"20":{"g":"1132","22":{"g":"1123"},"02":{"g":"0223"},"20":{"g":"0232"}},"22":{"g":"3130","04":{"g":"0313"}},"13":{"g":"1330"},"03":{"g":"3320","21":{"g":"3312"},"20":{"g":"1310"}},"11":{"g":"3112","30":{"g":"3122"},"20":{"g":"1110"},"12":{"g":"1232"},"03":{"g":"1223"},"13":{"g":"1213"},"11":{"g":"0322"}},"30":{"g":"0113","20":{"g":"0233"}},"10":{"g":"1122","30":{"g":"1112"},"20":{"g":"0222"}},"01":{"g":"1222","30":{"g":"1212"}},"04":{"g":"3310"}},"30":{"g":"0321","02":{"g":"2000","30":{"g":"2002"}},"12":{"g":"2101","20":{"g":"3001"},"30":{"g":"2201"},"22":{"g":"2011"}},"21":{"g":"2021"},"11":{"g":"1001"},"20":{"g":"0001"},"13":{"g":"2031"},"22":{"g":"2301"},"03":{"g":"2003"}},"13":{"g":"0102","13":{"g":"1200"},"04":{"g":"1020"},"22":{"g":"0012"}},"01":{"g":"1133","11":{"g":"3232","20":{"g":"3330"},"30":{"g":"3332"},"12":{"g":"3323"},"22":{"g":"3223"}},"22":{"g":"1313","22":{"g":"3113"}},"30":{"g":"3133","20":{"g":"1113"},"22":{"g":"1333"}},"20":{"g":"3233","21":{"g":"0333"}},"12":{"g":"3313"},"02":{"g":"3322"},"01":{"g":"3222"}},"00":{"g":"3333"},"04":{"g":"0210","22":{"g":"0120"}}}';
const tree = JSON.parse(treeJSON);

const states = [];
let currentState = tree;
let guesses = 0;

const guessLabel = document.getElementById('guess');

const numberToItem = { 0: 'Scroll', 1: 'Medal', 2: 'Drink', 3: 'Food' };

async function preload() {

    await Promise.all(Object.values(numberToItem).map(item => {
        const img = new Image();
        img.src = `images/${item}.gif`;
        return img.decode();
    }));

}

function reset(history = true) {

    states.length = 0;
    currentState = tree;
    guesses = 0;
    updateGuess();
    if (history) {
        clearHistory();
    }

}

function updateGuess() {

    guessLabel.innerText = `Guess #${guesses+1}`;

    const guess = currentState.g;

    for (let i = 0; i < 4; ++i) {
        const item = numberToItem[guess[i]];

        const img = document.getElementById(`i${i}`);
        img.src = `images/${item}.gif`;

        const label = document.getElementById(`l${i}`);
        label.innerText = item;
    }

}

function addHistory(left, right) {

    document.getElementById(`h${guesses}l`).innerHTML = left;
    document.getElementById(`h${guesses}r`).innerHTML = right;

}

function clearHistory() {

    for (let i = 0; i < 4; ++i) {
        document.getElementById(`h${i}l`).innerHTML = '';
        document.getElementById(`h${i}r`).innerHTML = '';
    }

}

function submit() {

    if (guesses === 0) {
        clearHistory();
    }

    const correct = radioValue('correct');
    const incorrect = radioValue('incorrect');

    const key = `${correct}${incorrect}`;
    const historyLeft = currentState.g.split('').map(n => `<img src="images/${numberToItem[n]}.gif">`).join('');
    let historyRight = '';

    if (key === '40') {
        addHistory(historyLeft, '<font color="#0b0">CLEAR</font>');
        reset(false);
    }
    else if (currentState.hasOwnProperty(key)) {
        addHistory(historyLeft, `${correct} correct, ${incorrect} incorrect`);
        states.push(currentState);
        currentState = currentState[key];
        ++guesses;
        updateGuess();
    }
    else {
        addHistory(historyLeft, `<font color="red">${correct} correct and ${incorrect} incorrect is IMPOSSIBLE</font>`);
    }

}

function radioValue(name) {

    const checked = document.querySelector(`input[name="${name}"]:checked`);
    return checked ? checked.value : 0;

}

function undo() {

    if (states.length > 0) {
        currentState = states.pop();
        addHistory('', '');
        --guesses;
        addHistory('', '');
        updateGuess();
    }

}

preload().then(() => reset());
