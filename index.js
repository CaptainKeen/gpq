
const treeJSON = '{"g":"2001","n":256,"w":1,"01":{"g":"1133","n":16,"w":1,"11":{"g":"3330","n":5,"w":1,"21":{"g":"3323","n":1,"w":1},"30":{"g":"3332","n":1,"w":1},"11":{"g":"3223","n":1,"w":1},"20":{"g":"3232","n":1,"w":1}},"20":{"g":"0333","n":2,"w":1,"21":{"g":"3233","n":1,"w":1}},"22":{"g":"1313","n":2,"w":1,"22":{"g":"3113","n":1,"w":1}},"02":{"g":"3322","n":1,"w":1},"30":{"g":"1333","n":3,"w":1,"20":{"g":"1113","n":1,"w":1},"22":{"g":"3133","n":1,"w":1}},"01":{"g":"3222","n":1,"w":1},"12":{"g":"3313","n":1,"w":1}},"04":{"g":"0210","n":2,"w":1,"22":{"g":"0120","n":1,"w":1}},"12":{"g":"1012","n":40,"w":1,"11":{"g":"0023","n":6,"w":1,"13":{"g":"0302","n":1,"w":1},"12":{"g":"0202","n":1,"w":1},"22":{"g":"3020","n":1,"w":1},"03":{"g":"1300","n":1,"w":1},"30":{"g":"0020","n":1,"w":1}},"20":{"g":"0013","n":6,"w":1,"22":{"g":"3010","n":1,"w":1},"21":{"g":"0032","n":1,"w":1},"13":{"g":"1030","n":1,"w":1},"30":{"g":"0010","n":1,"w":1},"20":{"g":"0022","n":1,"w":1}},"13":{"g":"2110","n":2,"w":1,"13":{"g":"0211","n":1,"w":1}},"02":{"g":"0013","n":6,"w":0,"12":{"g":"0100","n":1,"w":1},"11":{"g":"0200","n":1,"w":1},"04":{"g":"3100","n":1,"w":1},"22":{"g":"0103","n":1,"w":1},"21":{"g":"0203","n":1,"w":1},"03":{"g":"3200","n":1,"w":1}},"03":{"g":"2120","n":5,"w":1,"03":{"g":"0231","n":1,"w":1},"13":{"g":"0221","n":1,"w":1},"30":{"g":"2130","n":1,"w":1},"12":{"g":"0321","n":1,"w":1}},"30":{"g":"1022","n":4,"w":1,"20":{"g":"1010","n":1,"w":1},"30":{"g":"1032","n":1,"w":1},"21":{"g":"3012","n":1,"w":1}},"22":{"g":"1102","n":1,"w":1},"04":{"g":"0121","n":1,"w":1},"12":{"g":"2210","n":5,"w":1,"12":{"g":"1203","n":1,"w":1},"03":{"g":"3102","n":1,"w":1},"11":{"g":"1100","n":1,"w":1},"30":{"g":"2310","n":1,"w":1}},"21":{"g":"1202","n":3,"w":1,"30":{"g":"1302","n":1,"w":1},"12":{"g":"1023","n":1,"w":1}}},"10":{"g":"3131","n":18,"w":1,"01":{"g":"2223","n":2,"w":1,"22":{"g":"2322","n":1,"w":1}},"30":{"g":"1131","n":3,"w":1,"20":{"g":"3331","n":1,"w":1},"22":{"g":"3111","n":1,"w":1}},"22":{"g":"1331","n":2,"w":1,"22":{"g":"3311","n":1,"w":1}},"10":{"g":"2232","n":1,"w":1},"12":{"g":"1311","n":1,"w":1},"02":{"g":"2323","n":1,"w":1},"11":{"g":"2233","n":4,"w":1,"30":{"g":"2333","n":1,"w":1},"11":{"g":"3303","n":1,"w":1},"22":{"g":"2332","n":1,"w":1}},"20":{"g":"1111","n":2,"w":1,"00":{"g":"3033","n":1,"w":1}},"00":{"g":"2222","n":1,"w":1}},"21":{"g":"2013","n":20,"w":1,"12":{"g":"1021","n":5,"w":1,"03":{"g":"2102","n":1,"w":1},"20":{"g":"0031","n":1,"w":1},"02":{"g":"2300","n":1,"w":1},"11":{"g":"3002","n":1,"w":1}},"02":{"g":"0101","n":1,"w":1},"11":{"g":"1000","n":3,"w":1,"21":{"g":"0002","n":1,"w":1},"20":{"g":"2200","n":1,"w":1}},"03":{"g":"1201","n":2,"w":1,"20":{"g":"0301","n":1,"w":1}},"20":{"g":"0011","n":2,"w":1,"11":{"g":"2020","n":1,"w":1}},"13":{"g":"3021","n":1,"w":1},"30":{"g":"2012","n":1,"w":1},"21":{"g":"1003","n":2,"w":1,"12":{"g":"2030","n":1,"w":1}},"04":{"g":"3201","n":1,"w":1},"22":{"g":"2103","n":1,"w":1}},"03":{"g":"1230","n":20,"w":1,"11":{"g":"0110","n":1,"w":1},"20":{"g":"0220","n":1,"w":1},"03":{"g":"0112","n":2,"w":1,"30":{"g":"0122","n":1,"w":1}},"13":{"g":"0213","n":3,"w":1,"13":{"g":"0132","n":1,"w":1},"04":{"g":"3120","n":1,"w":1}},"04":{"g":"0123","n":2,"w":1,"13":{"g":"0312","n":1,"w":1}},"21":{"g":"1120","n":2,"w":1,"20":{"g":"0130","n":1,"w":1}},"30":{"g":"1210","n":3,"w":1,"30":{"g":"1220","n":1,"w":1},"20":{"g":"0230","n":1,"w":1}},"12":{"g":"0310","n":3,"w":1,"30":{"g":"0320","n":1,"w":1},"20":{"g":"0212","n":1,"w":1}},"22":{"g":"1320","n":2,"w":1,"13":{"g":"3210","n":1,"w":1}}},"11":{"g":"1231","n":46,"w":1,"20":{"g":"1033","n":3,"w":1,"13":{"g":"0331","n":1,"w":1},"11":{"g":"2230","n":1,"w":1}},"11":{"g":"1303","n":7,"w":1,"02":{"g":"0111","n":1,"w":1},"21":{"g":"3203","n":1,"w":1},"11":{"g":"3202","n":1,"w":1},"03":{"g":"3032","n":1,"w":1},"01":{"g":"2212","n":1,"w":1},"12":{"g":"2330","n":1,"w":1}},"10":{"g":"0033","n":4,"w":1,"01":{"g":"2220","n":1,"w":1},"22":{"g":"3030","n":1,"w":1},"30":{"g":"0030","n":1,"w":1}},"13":{"g":"3121","n":1,"w":1},"02":{"g":"3013","n":7,"w":1,"02":{"g":"2320","n":1,"w":1},"12":{"g":"3302","n":1,"w":1},"30":{"g":"3023","n":1,"w":1},"22":{"g":"3103","n":1,"w":1},"20":{"g":"3022","n":1,"w":1},"01":{"g":"2122","n":1,"w":1}},"12":{"g":"2133","n":7,"w":1,"02":{"g":"0311","n":1,"w":1},"04":{"g":"3321","n":1,"w":1},"11":{"g":"1013","n":1,"w":1},"20":{"g":"1103","n":1,"w":1},"30":{"g":"2132","n":1,"w":1},"21":{"g":"2213","n":1,"w":1}},"22":{"g":"1321","n":2,"w":1,"13":{"g":"3211","n":1,"w":1}},"04":{"g":"2113","n":1,"w":1},"30":{"g":"1211","n":3,"w":1,"30":{"g":"1221","n":1,"w":1},"20":{"g":"3231","n":1,"w":1}},"21":{"g":"0131","n":3,"w":1,"11":{"g":"3221","n":1,"w":1},"20":{"g":"1121","n":1,"w":1}},"01":{"g":"0303","n":3,"w":1,"30":{"g":"0300","n":1,"w":1},"22":{"g":"3300","n":1,"w":1}},"03":{"g":"2112","n":4,"w":1,"21":{"g":"2123","n":1,"w":1},"30":{"g":"2312","n":1,"w":1},"20":{"g":"2313","n":1,"w":1}}},"02":{"g":"0133","n":42,"w":1,"03":{"g":"3320","n":3,"w":1,"20":{"g":"1310","n":1,"w":1},"21":{"g":"3312","n":1,"w":1}},"20":{"g":"1123","n":4,"w":1,"20":{"g":"0223","n":1,"w":1},"02":{"g":"0232","n":1,"w":1},"22":{"g":"1132","n":1,"w":1}},"12":{"g":"1323","n":5,"w":1,"22":{"g":"1332","n":1,"w":1},"02":{"g":"3110","n":1,"w":1},"13":{"g":"3213","n":1,"w":1},"03":{"g":"3230","n":1,"w":1}},"11":{"g":"1213","n":7,"w":1,"20":{"g":"1110","n":1,"w":1},"30":{"g":"1223","n":1,"w":1},"21":{"g":"1232","n":1,"w":1},"02":{"g":"0322","n":1,"w":1},"03":{"g":"3122","n":1,"w":1},"13":{"g":"3112","n":1,"w":1}},"02":{"g":"1312","n":4,"w":1,"21":{"g":"3212","n":1,"w":1},"30":{"g":"1322","n":1,"w":1},"02":{"g":"3220","n":1,"w":1}},"04":{"g":"3310","n":1,"w":1},"01":{"g":"1212","n":2,"w":1,"30":{"g":"1222","n":1,"w":1}},"21":{"g":"0332","n":7,"w":1,"03":{"g":"3123","n":1,"w":1},"12":{"g":"1233","n":1,"w":1},"22":{"g":"0323","n":1,"w":1},"30":{"g":"0330","n":1,"w":1},"21":{"g":"3132","n":1,"w":1},"11":{"g":"1130","n":1,"w":1}},"13":{"g":"1330","n":1,"w":1},"30":{"g":"0113","n":2,"w":1,"20":{"g":"0233","n":1,"w":1}},"10":{"g":"1112","n":3,"w":1,"30":{"g":"1122","n":1,"w":1},"10":{"g":"0222","n":1,"w":1}},"22":{"g":"0313","n":2,"w":1,"04":{"g":"3130","n":1,"w":1}}},"13":{"g":"1200","n":4,"w":1,"13":{"g":"0102","n":1,"w":1},"22":{"g":"1020","n":1,"w":1},"04":{"g":"0012","n":1,"w":1}},"20":{"g":"3031","n":29,"w":1,"20":{"g":"2131","n":5,"w":1,"11":{"g":"1011","n":1,"w":1},"20":{"g":"2032","n":1,"w":1},"30":{"g":"2231","n":1,"w":1},"01":{"g":"3000","n":1,"w":1}},"10":{"g":"3211","n":6,"w":0,"20":{"g":"2221","n":1,"w":1},"21":{"g":"2111","n":1,"w":1},"01":{"g":"2022","n":1,"w":1},"12":{"g":"2121","n":1,"w":1},"30":{"g":"2211","n":1,"w":1},"00":{"g":"0000","n":1,"w":1}},"11":{"g":"2023","n":5,"w":1,"21":{"g":"2321","n":1,"w":1},"20":{"g":"0003","n":1,"w":1},"01":{"g":"1101","n":1,"w":1},"11":{"g":"2311","n":1,"w":1}},"02":{"g":"2203","n":2,"w":1,"22":{"g":"2302","n":1,"w":1}},"03":{"g":"2303","n":1,"w":1},"21":{"g":"3101","n":4,"w":1,"02":{"g":"2033","n":1,"w":1},"20":{"g":"3003","n":1,"w":1},"11":{"g":"2331","n":1,"w":1}},"12":{"g":"1301","n":1,"w":1},"30":{"g":"1031","n":2,"w":1,"22":{"g":"3011","n":1,"w":1}},"22":{"g":"3301","n":1,"w":1},"01":{"g":"2202","n":1,"w":1}},"30":{"g":"2130","n":12,"w":0,"12":{"g":"2011","n":4,"w":1,"20":{"g":"2003","n":1,"w":1},"30":{"g":"2021","n":1,"w":1},"21":{"g":"2201","n":1,"w":1}},"20":{"g":"2000","n":1,"w":1},"02":{"g":"0001","n":2,"w":1,"30":{"g":"1001","n":1,"w":1}},"11":{"g":"2002","n":1,"w":1},"21":{"g":"2101","n":1,"w":1},"13":{"g":"2301","n":1,"w":1},"22":{"g":"2031","n":1,"w":1},"03":{"g":"3001","n":1,"w":1}},"22":{"g":"2010","n":5,"w":1,"13":{"g":"0021","n":2,"w":1,"13":{"g":"1002","n":1,"w":1}},"22":{"g":"2100","n":1,"w":1},"04":{"g":"0201","n":1,"w":1}},"00":{"g":"3333","n":1,"w":1}}';
const tree = JSON.parse(treeJSON);

const states = [];
let currentState = tree;
let guesses = 0;

const guessLabel = document.getElementById('guess');
const chanceLabel = document.getElementById('chance');

const numberToItem = { 0: 'Scroll', 1: 'Medal', 2: 'Drink', 3: 'Food' };

function reset(history = true) {

    states.length = 0;
    currentState = tree;
    guesses = 0;
    updateGuess();
    if (history) {
        clearHistory();
    }

}

function updateGuess() {

    guessLabel.innerText = `Guess #${guesses+1}`;

    const guess = currentState.g;
    const clearChance = currentState.w ? (1 / currentState.n) : 0;
    chanceLabel.innerText = `Clear chance: ${clearChance.toLocaleString(
        undefined,
        { style: 'percent', maximumFractionDigits: 2 }
    )}`;

    for (let i = 0; i < 4; ++i) {
        const item = numberToItem[guess[i]];

        const img = document.getElementById(`i${i}`);
        img.className = item;

        const label = document.getElementById(`l${i}`);
        label.innerText = item;
    }

}

function addHistory(left, right) {

    document.getElementById(`h${guesses}l`).innerHTML = left;
    document.getElementById(`h${guesses}r`).innerHTML = right;

}

function clearHistory() {

    for (let i = 0; i < 4; ++i) {
        document.getElementById(`h${i}l`).innerHTML = '';
        document.getElementById(`h${i}r`).innerHTML = '';
    }

}

function submit() {

    if (guesses === 0) {
        clearHistory();
    }

    const correct = radioValue('correct');
    const incorrect = radioValue('incorrect');

    const key = `${correct}${incorrect}`;
    const historyLeft = currentState.g.split('').map(n => `<img class="${numberToItem[n]}">`).join('');
    let historyRight = '';

    if (key === '40') {
        addHistory(historyLeft, '<font color="#0b0">CLEAR</font>');
        reset(false);
    }
    else if (currentState.hasOwnProperty(key)) {
        addHistory(historyLeft, `${correct} correct, ${incorrect} incorrect`);
        states.push(currentState);
        currentState = currentState[key];
        ++guesses;
        updateGuess();
    }
    else {
        addHistory(historyLeft, `<font color="red">${correct} correct and ${incorrect} incorrect is IMPOSSIBLE</font>`);
    }

}

function radioValue(name) {

    const checked = document.querySelector(`input[name="${name}"]:checked`);
    return checked ? checked.value : 0;

}

function undo() {

    if (states.length > 0) {
        currentState = states.pop();
        addHistory('', '');
        --guesses;
        addHistory('', '');
        updateGuess();
    }

}

reset();
